ЖУРНАЛ ПРЕДЗАПИСИ

Логически журнал можно представить в виде непрерывного потока записей. Каждая запись имеет номер, называемый LSN (Log Sequence Number). Это 64-разрядное число — смещение записи в байтах относительно начала журнала.

Текущую позицию показывает функция pg\_current\_wal\_lsn:

postgres=# SELECT pg\_current\_wal\_lsn();

pg\_current\_wal\_lsn

\--------------------

0/27E58A0

(1 row)

Позиция записывается как два 32-разрядных числа через косую черту. Запомним это значение.

Выполним теперь какие-нибудь операции и посмотрим, как изменилась позиция.

postgres=# UPDATE t SET n = 100\_001 WHERE n = 1;

UPDATE 1

postgres=# SELECT pg\_current\_wal\_lsn();

pg\_current\_wal\_lsn

\--------------------

0/27E58A0

(1 row)

Интересны не абсолютные числа, а их разница, которая показывает размер сгенерированных журнальных записей в байтах:

postgres=# SELECT '0/236A060'::pg\_lsn - '0/2367030'::pg\_lsn AS bytes;

bytes

\-------

12336

(1 row)

Физически журнал хранится в файлах в отдельном каталоге (PGDATA/pg\_wal). По умолчанию файлы имеют размер 16 Мбайт, задать другой размер можно при инициализации кластера баз данных.

На файлы можно взглянуть не только средствами файловой системы, но и с помощью функции:

postgres=# SELECT \* FROM pg\_ls\_waldir() ORDER BY name LIMIT 10;

name           |   size   |      modification

--------------------------+----------+------------------------

000000010000000000000001 | 16777216 | 2024-10-28 11:46:04+03

000000010000000000000002 | 16777216 | 2024-10-28 11:46:53+03

(2 rows)

